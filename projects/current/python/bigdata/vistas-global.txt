
evento 18 - Corner+Anotacion

create view corner_ano as
select a.MatchID, 
a.Minute, 
case
	when a.EventTypeID='118'	then 'GOL'
	else 'FALLO'
end as Exito, 
a.SubjectTeamID,
case
	when a.SubjectTeamID=b.HomeTeamID THEN 'Local'
	else 'Visitante' 
end as Equipo,
a.SubjectPlayerID, 
a.SubAnotacion, 
(b.PossessionFirstHalfHome+b.PossessionSecondHalfHome)/2 as PosMedia,
case
	when a.SubjectTeamID=b.HomeTeamID THEN b.RatingIndirectSetPiecesAtthome
	else b.RatingIndirectSetPiecesAttaway 
end as BPInd_Att,
case
	when a.SubjectTeamID=b.HomeTeamID THEN b.RatingIndirectSetPiecesDefaway
	else b.RatingIndirectSetPiecesdefhome 
end as BPInd_Def
from eventos as a
left join partidos as b ON a.MatchID=b.MatchID
where EventTypeID='118' or EventTypeID='218'


[Ev19 Cor+CAB]

select a.MatchID, 
a.Minute, 
case
	when a.EventTypeID='119'	then 'GOL'
	else 'FALLO'
end as Exito, 
a.SubjectTeamID,
case
	when a.SubjectTeamID=b.HomeTeamID THEN '1'
	else '2' 
end as Equipo,
a.SubjectPlayerID,
a.ObjectPlayerID,
(b.PossessionFirstHalfHome+b.PossessionSecondHalfHome)/2 as PosMedia,
a.Objanotacion as BPBepero,
case
	when a.SubjectTeamID=b.HomeTeamID THEN b.RatingIndirectSetPiecesAtthome
	else b.RatingIndirectSetPiecesAttaway 
end as BPInd_Att,
case
	when a.SubjectTeamID=b.HomeTeamID THEN b.RatingIndirectSetPiecesDefaway
	else b.RatingIndirectSetPiecesdefhome 
end as BPInd_Def,
c.NumCABHome, 
c.MaxMinHome, 
c.NumCABAway, 
c.MaxMinAway
from eventos as a
left join partidos as b ON a.MatchID=b.MatchID
left join NumCAB as c ON a.matchID=c.matchId
where EventTypeID='119' or EventTypeID='219'

Para contar cuantos Cabezones hay en el campo por equipo
select MatchID,RoleTeam,Specialty,max(Minutos),count(Pos)
from (select * from alineacion_all where Pos > 99)
group by MatchID,RoleTeam,Specialty
having Specialty = 5

select distinct a.MatchID, case when b.NumCAB is null then '0' else b.NumCAB end as NumCABHome, b.MaxMin as MaxMinHome, case when c.NumCAB is null then '0' else c.NumCAB end as NumCABAway, c.MaxMin as MaxMinAway
from partidos as a
left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumCAB from (select * from alineacion_all where Pos > 99) group by MatchID,RoleTeam,Specialty having Specialty = 5 and RoleTeam='1') as b ON a.MatchID=b.MatchID
left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumCAB from (select * from alineacion_all where Pos > 99) group by MatchID,RoleTeam,Specialty having Specialty = 5 and RoleTeam='2') as c ON a.MatchID=c.MatchID

Partidos sin creativos y sacando sin cabezones
select distinct a.matchid,b.matchid, b.NumCABHome+b.NumCABAway as CAB
from partidos as a
inner join NumCAB as b on a.matchid=b.matchid
where TacticTypeHome<>7 and TacticTypeAway<>7 and CAB<>0


EV35 DEL+XP
create view del_xp as
select a.MatchID, 
a.Minute, 
case
	when a.EventTypeID='135'	then 'GOL'
	else 'FALLO'
end as Exito, 
(b.PossessionFirstHalfHome+b.PossessionSecondHalfHome)/2 as PosMedia,
a.SubXP as XP_Del,
a.SubAnotacion as Ano_Del
from eventos as a
left join partidos as b ON a.MatchID=b.MatchID
where EventTypeID='135' or EventTypeID='235'


RAPIDOS
CREATE VIEW NumRAP as 
select distinct a.MatchID, case when b.NumRAP is null then 0 else b.NumRAP end as NumRAPHome, case when b.NumRAP is null then 0 else b.MaxMin end as MaxMinHome, case when c.NumRAP is null then 0 else c.NumRAP end as NumRAPAway, case when c.NumRAP is null then 0 else c.MaxMin end as MaxMinAway 
from partidos as a 
left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumRAP from (select * from alineacion_all where Pos > 105) group by MatchID,RoleTeam,Specialty having Specialty = 2 and RoleTeam='1') as b ON a.MatchID=b.MatchID 
left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumRAP from (select * from alineacion_all where Pos > 105) group by MatchID,RoleTeam,Specialty having Specialty = 2 and RoleTeam='2') as c ON a.MatchID=c.MatchID

create view NumRAP_Pond as
select MatchId,case 
when NumRAPHome=0 and NumRAPAway=0 then 0
when NumRAPHome=0 and NumRAPAway<>0 then NumRAPAway
when NumRAPAway=0 and NumRAPHome<>0 then NumRAPHome
when NumRAPAway<>0 and NumRAPHome<>0 then NumRAPAway+NumRAPHome
end as TotalRAP_real,
case 
when NumRAPHome=0 and NumRAPAway=0 then 0
when NumRAPHome=0 and NumRAPAway<>0 then NumRAPAway*2
when NumRAPAway=0 and NumRAPHome<>0 then NumRAPHome*2
when NumRAPAway<>0 and NumRAPHome<>0 then NumRAPAway+NumRAPHome
end as TotalRAP_Pond
from NumRAP
where TotalRAP_Pond<>0

create view rap_pases as
select a.MatchID, 
a.Minute, 
case
	when a.EventTypeID='116'	then 'GOL'
	else 'FALLO'
end as Exito, 
a.SubAnotacion as Ano_Del,
a.ObjPases as Pas_Pas,
c.TotalRAP_Pond
from eventos as a
left join partidos as b ON a.MatchID=b.MatchID
left join NumRAP_Pond as c ON a.MatchId=c.matchID
where EventTypeID='116' or EventTypeID='216'


GENERAL

create view partido_equipo_numEv as 
select MatchID, SubjectTeamID, count(EventTypeID) as NumEV
from (select a.MatchID, a.EventTypeID, a.SubjectTeamID from eventos as a left join SE as b ON a.EventTypeID=b.EventTypeID where TypeSEBD='SE')
group by MatchID, SubjectTeamID

create view partido_SE_equipo as
select a.matchID, 
a.HomeTeamID, 
(a.PossessionFirstHalfHome+a.PossessionSecondHalfHome)/2 as PosMediaHome, 
(a.PossessionFirstHalfAway+a.PossessionSecondHalfAway)/2 as PosMediaAway, 
a.AwayTeamID, a.TacticTypeHome, a.TacticSkillHome, a.TacticTypeAway, a.TacticSkillAway, 
case when b.NumEV is null then 0 else b.NumEV end as NumEVHome, 
case when c.NumEV is null then 0 else c.NumEV end as NumEVAway
from partidos as a
left join partido_equipo_numEv as b ON a.matchID=b.matchID and a.HomeTeamID=b.SubjectTeamID
left join partido_equipo_numEv as c ON a.matchID=c.matchID and a.AwayTeamID=c.SubjectTeamID

Agrupacion por numero de eventos en el partido
select case 
when TacticTypeHome <> 7 and TacticTypeAway <> 7 then 0
when TacticTypeHome = 7 and TacticTypeAway <> 7 then 1
when TacticTypeHome <> 7 and TacticTypeAway = 7 then 1
when TacticTypeHome = 7 and TacticTypeAway = 7 then 2
end as NumEqCreativos,
NumEVHome+NumEVAway as NumEV,
count(MatchID) as NumPartidos
from partido_SE_equipo
group by NumEqCreativos,NumEV

TECNICOS

create view NumTEC as
select distinct a.MatchID, case when b.NumTEC is null then 0 else b.NumTEC end as NumTECHome, case when b.NumTEC is null then 0 else b.MaxMin end as MaxMinHome, case when c.NumTEC is null then 0 else c.NumTEC end as NumTECAway, case when c.NumTEC is null then 0 else c.MaxMin end as MaxMinAway 
from partidos as a 
left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumTEC from (select distinct MatchID,Player,RoleTeam,Specialty,Pos,Minutos from alineacion_all_contrarios_tec_cab where Pos > 105 and Specialty = 1 and "Specialty:1" = 5) group by MatchID,RoleTeam,Specialty having RoleTeam='1') as b ON a.MatchID=b.MatchID 
left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumTEC from (select distinct MatchID,Player,RoleTeam,Specialty,Pos,Minutos from alineacion_all_contrarios_tec_cab where Pos > 105 and Specialty = 1 and "Specialty:1" = 5) group by MatchID,RoleTeam,Specialty having RoleTeam='2') as c ON a.MatchID=c.MatchID

create view NumTEC_Pond as
select MatchId,case 
when NumTECHome=0 and NumTECAway=0 then 0
when NumTECHome=0 and NumTECAway<>0 then NumTECAway
when NumTECAway=0 and NumTECHome<>0 then NumTECHome
when NumTECAway<>0 and NumTECHome<>0 then NumTECAway+NumTECHome
end as TotalTEC_real,
case 
when NumTECHome=0 and NumTECAway=0 then 0
when NumTECHome=0 and NumTECAway<>0 then NumTECAway*2
when NumTECAway=0 and NumTECHome<>0 then NumTECHome*2
when NumTECAway<>0 and NumTECHome<>0 then NumTECAway+NumTECHome
end as TotalTEC_Pond
from NumTEC
where TotalTEC_Pond<>0


LATERAL

IMPREVISIBLES

CREATE VIEW NumIMP05 as 
select distinct a.MatchID, d.ptotal_sobre, 
case when b.NumIMP05 is null then 0 else b.NumIMP05 end as NumIMP05Home, case when b.NumIMP05 is null then 0 else b.MaxMin end as MaxMinHome, case when c.NumIMP05 is null then 0 else c.NumIMP05 end as NumIMP05Away, case when c.NumIMP05 is null then 0 else c.MaxMin end as MaxMinAway from partidos as a left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumIMP05 from (select * from alineacion_all where Pos > 99 and Pos < 106) group by MatchID,RoleTeam,Specialty having Specialty = 4 and RoleTeam='1') as b ON a.MatchID=b.MatchID left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumIMP05 from (select * from alineacion_all where Pos > 99 and Pos < 106) group by MatchID,RoleTeam,Specialty having Specialty = 4 and RoleTeam='2') as c ON a.MatchID=c.MatchID 
left join partidos_ptotal_sobre as d ON a.MatchID=d.matchID 
where TacticTypeHome <>7 and TacticTypeaway <>7

drop view NumIMP05

CREATE VIEW NumIMP05 as 
select distinct a.MatchID,  
case when b.NumIMP05 is null then 0 else b.NumIMP05 end as NumIMP05Home, case when b.NumIMP05 is null then 0 else b.MaxMin end as MaxMinHome, case when c.NumIMP05 is null then 0 else c.NumIMP05 end as NumIMP05Away, case when c.NumIMP05 is null then 0 else c.MaxMin end as MaxMinAway from partidos as a left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumIMP05 from (select * from alineacion_all where Pos > 99 and Pos < 106) group by MatchID,RoleTeam,Specialty having Specialty = 4 and RoleTeam='1') as b ON a.MatchID=b.MatchID left join (select MatchID,RoleTeam,Specialty,max(Minutos) as MaxMin,count(Pos) as NumIMP05 from (select * from alineacion_all where Pos > 99 and Pos < 106) group by MatchID,RoleTeam,Specialty having Specialty = 4 and RoleTeam='2') as c ON a.MatchID=c.MatchID 
where TacticTypeHome <>7 and TacticTypeaway <>7

drop view NumIMP05_Pond

CREATE VIEW NumIMP05_Pond as 
select MatchId, ptotal_sobre, case when NumIMP05Home=0 and NumIMP05Away=0 then 0 when NumIMP05Home=0 and NumIMP05Away<>0 then NumIMP05Away when NumIMP05Away=0 and NumIMP05Home<>0 then NumIMP05Home when NumIMP05Away<>0 and NumIMP05Home<>0 then NumIMP05Away+NumIMP05Home end as TotalIMP_real, case when NumIMP05Home=0 and NumIMP05Away=0 then 0 when NumIMP05Home=0 and NumIMP05Away<>0 then NumIMP05Away*2 when NumIMP05Away=0 and NumIMP05Home<>0 then NumIMP05Home*2 when NumIMP05Away<>0 and NumIMP05Home<>0 then NumIMP05Away+NumIMP05Home end as TotalIMP05_Pond
from NumIMP05 where TotalIMP05_Pond<>0

PTOTAL

create table partidos_ptotal_sobre as
select matchID, ev05,ev06,ev08,ev09,ev15,ev16,ev19,ev25,ev37,ev38,ev39,cast(pTOTAL as real) as ptotal_sobre
from partidos_plus_pbase_ptotal



Cabezones
select distinct a.MatchID 
from alineacion_all as a
left join partidos as b ON a.matchid=b.matchID 
where a.Specialty = 5 and b.TacticTypeHome <> 7 and b.TacticTypeAway <> 7

--partidos LAT+CAB sin JC
select *
from Partidos_Lat37_Con_Cab as a
left join partidos as b ON a.matchid=b.matchid
where b.TacticTypeHome<>7 and b.TacticTypeAway<>7 and a.NumExt=1




UPDATE Especialidades
update eventos
set SubSpecialty=(select Specialty from jugadores where PlayerID=eventos.SubjectPlayerID)
where SubSpecialty='-99'

LIMPIAR partidos sin datos
--Partidos sin datos
select *
from partidos as a
left join eventos as b ON a.matchid=b.matchid
where a.TacticTypeHome is null and b.MatchId is null

delete from partidos 
where TacticTypeHome is null

PAra los WO
delete from alineacion
where matchID IN (select MatchId from partidos_wo)

delete from lesiones
where matchID IN (select MatchId from partidos_wo)


DELANTERO con XP
--pàrtidos con delanteros y sin JC
select distinct a.matchid
from alineacion_all as a
left join partidos as b ON a.matchId=b.matchId
where a.Pos>110 and b.TacticTypeHome<>7 and b.TacticTypeAway<>7




CREATE VIEW partidos_plus_pbase as 
select a.MatchID, 
case when b.matchID is null then 0 else 0.5470 end as ev05, 
case when c.matchID is null then 0 else 0.4845 end as ev06, 
case when d.matchID is null then 0 else 0.5428 end as ev08, 
case when e.matchID is null then 0 else 0.0063 end as ev09, 
case when f.matchID is null then 0 else 0.6334 end as ev15, 
case when f.matchID is null then 0 else 0.6559 end as ev16, 
case when g.CABs is null or g.CABs = 0 then 0 else 0.2192 end as ev19, 
case when h.matchID is null then 0 else 0.0050 end as ev25, 
case when i.matchID is null then 0 else 0.2054 end as ev37, 
case when j.matchID is null then 0 else 0.1412 end as ev38, 
case when k.matchID is null then 0 else 0.7313 end as ev39 
from partidos as a 
left join NumIMP05_Pond as b ON a.matchID=b.matchID 
left join NumIMP06_Pond as c ON a.matchID=c.matchID 
left join NumIMP08_Pond as d ON a.matchID=d.matchID 
left join NumIMP09_Pond as e ON a.matchID=e.matchID 
left join NumRAP_Pond as f ON a.matchID=f.matchID 
left join (select distinct matchId, NumCABHome+NumCABAway as CABs from NumCAB) as g ON a.matchID=g.matchID 
left join NumIMP25_Pond as h ON a.matchID=h.matchID 
left join Partidos_Lat37_Con_Cab as i ON a.matchID=i.matchID 
left join lateral as j ON a.matchID=j.matchID 
left join NumTEC_Pond as k ON a.matchID=k.matchID


estadisticas ponderdas

select matchid, cast(ptotal_sobre*10000 as int) as pbase, TotalIMP_real, TotalIMP25_Pond
from NumIMP25_Pond




drop table partidos_ptotal_sobre_all

create table partidos_ptotal_sobre_all as
select matchID, ev05,ev06,ev08,ev09,ev15,ev16,ev19,ev25,ev37,ev38,ev39,cast(pTOTAL as real) as ptotal_sobre
from partidos_plus_pbase_ptotal

drop table partidos_ptotal_sobre

create table partidos_ptotal_sobre as
select a.matchID, ev05,ev06,ev08,ev09,ev15,ev16,ev19,ev25,ev37,ev38,ev39,ptotal_sobre
from partidos_ptotal_sobre_all as a
inner join partidos as b ON a.matchID=b.matchid
where b.TacticTypeHome<>7 and b.TacticTypeAway<>7



partidos con 5 eventos

select a.matchid,  b.TacticTypeHome, b.TacticTypeAway, count(a.IndexEv)
from (select a.matchid,a.IndexEv from eventos as a inner join SE as b ON a.EventTypeID=b.EventTypeID where b.TypeSEBD='SE') as a
inner join partidos as b ON a.matchid=b.matchid
group by a.matchid,b.TacticTypeHome, b.TacticTypeAway
having b.TacticTypeHome<>7 and b.TacticTypeAway<>7 and count(a.IndexEv) > 4



RECONSTRUIR LA PBASE OBSERVADA


drop view partidos_plus_pbase

CREATE VIEW partidos_plus_pbase as 
select a.MatchID, 
case when b.matchID is null then 0 else 0.5325 end as ev05, 
case when c.matchID is null then 0 else 0.4845 end as ev06, 
case when d.matchID is null then 0 else 0.5428 end as ev08, 
case when e.matchID is null then 0 else 0.0134 end as ev09, 
case when f.matchID is null then 0 else 0.6334 end as ev15, 
case when f.matchID is null then 0 else 0.6559 end as ev16, 
case when g.CABs is null or g.CABs = 0 then 0 else 0.2192 end as ev19, 
case when h.matchID is null then 0 else 0.0045 end as ev25, 
case when i.matchID is null then 0 else 0.2054 end as ev37, 
case when j.matchID is null then 0 else 0.1412 end as ev38, 
case when k.matchID is null then 0 else 0.7313 end as ev39 
from partidos as a 
left join NumIMP05_Pond as b ON a.matchID=b.matchID 
left join NumIMP06_Pond as c ON a.matchID=c.matchID 
left join NumIMP08_Pond as d ON a.matchID=d.matchID 
left join NumIMP09_Pond as e ON a.matchID=e.matchID 
left join NumRAP_Pond as f ON a.matchID=f.matchID 
left join (select distinct matchId, NumCABHome+NumCABAway as CABs from NumCAB) as g ON a.matchID=g.matchID 
left join NumIMP25_Pond as h ON a.matchID=h.matchID 
left join Partidos_Lat37_Con_Cab as i ON a.matchID=i.matchID 
left join lateral as j ON a.matchID=j.matchID 
left join NumTEC_Pond as k ON a.matchID=k.matchID


drop view partidos_plus_pbase_ptotal
CREATE VIEW partidos_plus_pbase_ptotal as select *,cast( ev05+ev06+ev08+ev09+ev15+ev16+0.0128+0.1892+ev19+ev25+0.0499+0.0399+ev37+ev38+ev39 as real) as pTOTAL from partidos_plus_pbase

DROP TABLE partidos_ptotal_sobre_all
CREATE TABLE partidos_ptotal_sobre_all AS SELECT matchID, ev05,ev06,ev08,ev09,ev15,ev16,ev19,ev25,ev37,ev38,ev39,cast(pTOTAL as real) as ptotal_sobre FROM partidos_plus_pbase_ptotal
DROP TABLE  partidos_ptotal_sobre
--CREATE TABLE partidos_ptotal_sobre as select a.matchID, ev05,ev06,ev08,ev09,ev15,ev16,ev19,ev25,ev37,ev38,ev39,ptotal_sobre from partidos_ptotal_sobre_all as a inner join partidos as b ON a.matchID=b.matchid where b.TacticTypeHome<>7 and b.TacticTypeAway<>7
CREATE TABLE partidos_ptotal_sobre as select a.matchID, ev05,ev06,ev08,ev09,ev15,ev16,ev19,ev25,ev37,ev38,ev39,cast(ptotal_sobre*10000 as int) as ptotal_sobre from partidos_ptotal_sobre_all as a inner join partidos as b ON a.matchID=b.matchid where b.TacticTypeHome<>7 and b.TacticTypeAway<>7





